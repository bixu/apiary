on:
  release:
    types: [created]

jobs:
  apiary:
    name: apiary ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-13
          - macos-14
    steps:
      - uses: actions/checkout@v4

      - id: build
        run: |

          set -x
          if uname -m | grep -q x86_64 && uname -s | grep Darwin
          then
            export TARGET=x86_64-apple-darwin
          fi

          if uname -m | grep -q arm64 && uname -s | grep Darwin
          then
            export TARGET=aarch64-apple-darwin
          fi
          set +x

          uname -a
          echo "Rust target is $TARGET"
          echo "target=$TARGET" >> $GITHUB_OUTPUT

      - run: rustup toolchain install stable --profile minimal

      - run: rustup target add ${{ steps.build.outputs.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Compile and release
        id: compile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUSTTARGET: ${{ steps.build.outputs.target }}
        run: |
          cargo build --release --target "${RUSTTARGET}"
          
          # Create directory for packaging
          mkdir -p dist
          
          # Copy binary and create tar.gz archive
          cp target/${RUSTTARGET}/release/apiary dist/
          tar -czf apiary-${RUSTTARGET}.tar.gz -C dist apiary
          
          # Calculate SHA256 for Homebrew formula
          sha256sum apiary-${RUSTTARGET}.tar.gz > apiary-${RUSTTARGET}.tar.gz.sha256
          
          echo "archive=apiary-${RUSTTARGET}.tar.gz" >> $GITHUB_OUTPUT
          echo "sha256_file=apiary-${RUSTTARGET}.tar.gz.sha256" >> $GITHUB_OUTPUT

      - name: Upload release archive
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./apiary-${{ steps.build.outputs.target }}.tar.gz
          asset_name: apiary-${{ steps.build.outputs.target }}.tar.gz
          asset_content_type: application/gzip

  trigger-homebrew-update:
    needs: apiary
    runs-on: ubuntu-latest
    if: github.event.action == 'published'
    steps:
      - name: Trigger Homebrew tap update
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/bixu/homebrew-apiary/dispatches \
            -d "{
              \"event_type\": \"update-formula\",
              \"client_payload\": {
                \"version\": \"${{ github.event.release.tag_name }}\",
                \"release_url\": \"${{ github.event.release.html_url }}\"
              }
            }"
