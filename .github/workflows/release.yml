name: Release

on:
  push:
    branches:
      - main
    paths:
      - 'Cargo.toml'

jobs:
  check_version:
    name: Check Version and Create Draft Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_created: ${{ steps.release.outputs.release_created }}
      upload_url: ${{ steps.release.outputs.upload_url }}
      release_id: ${{ steps.release.outputs.release_id }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"

      - name: Check if tag exists
        id: tag_check
        run: |
          if git tag --list | grep -q "^${{ steps.version.outputs.version }}$"; then
            echo "Tag ${{ steps.version.outputs.version }} already exists"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Tag ${{ steps.version.outputs.version }} does not exist"
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create tag and draft release
        id: release
        if: steps.tag_check.outputs.tag_exists == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="$VERSION"
          
          # Create and push tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release version $VERSION"
          git push origin "$TAG_NAME"
          
          # Create draft GitHub release
          response=$(curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            -d "{
              \"tag_name\": \"$TAG_NAME\",
              \"target_commitish\": \"${{ github.sha }}\",
              \"name\": \"Release $VERSION\",
              \"body\": \"Release version $VERSION\",
              \"draft\": true,
              \"prerelease\": false
            }")
          
          upload_url=$(echo "$response" | jq -r '.upload_url')
          release_id=$(echo "$response" | jq -r '.id')
          
          echo "release_created=true" >> $GITHUB_OUTPUT
          echo "upload_url=$upload_url" >> $GITHUB_OUTPUT
          echo "release_id=$release_id" >> $GITHUB_OUTPUT
          echo "Created draft release with ID: $release_id and upload URL: $upload_url"

  apiary:
    name: apiary ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: check_version
    if: needs.check_version.outputs.release_created == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-apple-darwin
            os: macos-13
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - id: build
        run: |
          export TARGET="${{ matrix.target }}"
          echo "Rust target is $TARGET"
          echo "target=$TARGET" >> $GITHUB_OUTPUT

      - run: rustup toolchain install stable --profile minimal

      - run: rustup target add ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Compile and release
        id: compile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUSTTARGET: ${{ matrix.target }}
        run: |
          cargo build --release --target "${RUSTTARGET}"
          
          # Create directory for packaging
          mkdir -p dist
          
          # Copy binary and create tar.gz archive
          cp target/${RUSTTARGET}/release/apiary dist/
          tar -czf apiary-${RUSTTARGET}.tar.gz -C dist apiary
          
          # Calculate SHA256 on the built archive (before upload)
          echo "Calculating SHA256 for apiary-${RUSTTARGET}.tar.gz..."
          if command -v sha256sum >/dev/null 2>&1; then
            sha256=$(sha256sum apiary-${RUSTTARGET}.tar.gz | awk '{print $1}')
          else
            sha256=$(shasum -a 256 apiary-${RUSTTARGET}.tar.gz | awk '{print $1}')
          fi
          
          echo "SHA256 for apiary-${RUSTTARGET}.tar.gz: $sha256"
          echo "archive=apiary-${RUSTTARGET}.tar.gz" >> $GITHUB_OUTPUT
          echo "sha256=$sha256" >> $GITHUB_OUTPUT
          
          # Save SHA256 to file for artifact upload
          echo "$sha256" > apiary-${RUSTTARGET}.tar.gz.sha256

      - name: Upload release archive as artifact
        uses: actions/upload-artifact@v6
        with:
          name: release-archive-${{ matrix.target }}
          path: apiary-${{ matrix.target }}.tar.gz
          retention-days: 1

      - name: Upload SHA256 as artifact
        uses: actions/upload-artifact@v6
        with:
          name: sha256-${{ matrix.target }}
          path: apiary-${{ matrix.target }}.tar.gz.sha256

  upload_artifacts:
    name: Upload Artifacts to Draft Release
    needs: [check_version, apiary]
    runs-on: ubuntu-latest
    if: needs.check_version.outputs.release_created == 'true'
    outputs:
      sha256_aarch64_apple_darwin: ${{ steps.collect_sha256.outputs.sha256_aarch64_apple_darwin }}
      sha256_x86_64_apple_darwin: ${{ steps.collect_sha256.outputs.sha256_x86_64_apple_darwin }}
      sha256_x86_64_unknown_linux_gnu: ${{ steps.collect_sha256.outputs.sha256_x86_64_unknown_linux_gnu }}
    steps:
      - name: Download release archives
        uses: actions/download-artifact@v7
        with:
          pattern: release-archive-*
          merge-multiple: true

      - name: Download SHA256 artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: sha256-*
          merge-multiple: true

      - name: Collect SHA256 values
        id: collect_sha256
        run: |
          # Read SHA256 values from the downloaded files
          if [ -f "apiary-aarch64-apple-darwin.tar.gz.sha256" ]; then
            sha256_aarch64=$(cat apiary-aarch64-apple-darwin.tar.gz.sha256 | tr -d '\n\r ')
            echo "sha256_aarch64_apple_darwin=$sha256_aarch64" >> $GITHUB_OUTPUT
            echo "Found SHA256 for aarch64-apple-darwin: $sha256_aarch64"
          else
            echo "❌ Error: SHA256 file for aarch64-apple-darwin not found"
            exit 1
          fi
          
          if [ -f "apiary-x86_64-apple-darwin.tar.gz.sha256" ]; then
            sha256_x86_64_darwin=$(cat apiary-x86_64-apple-darwin.tar.gz.sha256 | tr -d '\n\r ')
            echo "sha256_x86_64_apple_darwin=$sha256_x86_64_darwin" >> $GITHUB_OUTPUT
            echo "Found SHA256 for x86_64-apple-darwin: $sha256_x86_64_darwin"
          else
            echo "❌ Error: SHA256 file for x86_64-apple-darwin not found"
            exit 1
          fi
          
          if [ -f "apiary-x86_64-unknown-linux-gnu.tar.gz.sha256" ]; then
            sha256_x86_64_linux=$(cat apiary-x86_64-unknown-linux-gnu.tar.gz.sha256 | tr -d '\n\r ')
            echo "sha256_x86_64_unknown_linux_gnu=$sha256_x86_64_linux" >> $GITHUB_OUTPUT
            echo "Found SHA256 for x86_64-unknown-linux-gnu: $sha256_x86_64_linux"
          else
            echo "❌ Error: SHA256 file for x86_64-unknown-linux-gnu not found"
            exit 1
          fi
          
          echo "✅ Successfully collected all SHA256 values from built files"

      - name: Upload artifacts to draft release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ needs.check_version.outputs.upload_url }}
        run: |
          # Validate upload_url is set
          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" == "null" ]; then
            echo "❌ Error: upload_url is not set or is null"
            exit 1
          fi
          
          # Find all tar.gz files
          archives=$(find . -name "apiary-*.tar.gz" -type f)
          
          echo "Found archives to upload:"
          echo "$archives"
          
          # Remove {?name,label} template from upload_url
          upload_url_base="${UPLOAD_URL%\{*}"
          
          for archive in $archives; do
            filename=$(basename "$archive")
            echo "Uploading $filename to draft release..."
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/gzip" \
              "$upload_url_base?name=$filename" \
              --data-binary "@$archive")
            http_code=$(echo "$response" | tail -n1)
            if [ "$http_code" -eq 201 ]; then
              echo "✅ Successfully uploaded $filename"
            else
              echo "❌ Failed to upload $filename (HTTP $http_code)"
              echo "$response" | head -n-1
              exit 1
            fi
          done
          
          echo "✅ All artifacts uploaded successfully"

  publish_release:
    name: Publish Release
    needs: [check_version, upload_artifacts]
    runs-on: ubuntu-latest
    if: needs.check_version.outputs.release_created == 'true'
    steps:
      - name: Publish draft release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_ID: ${{ needs.check_version.outputs.release_id }}
        run: |
          echo "Publishing release ID: $RELEASE_ID"
          curl -X PATCH \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID \
            -d '{"draft": false}'
          echo "✅ Release published successfully"

  trigger-homebrew-update:
    needs: [check_version, upload_artifacts, publish_release]
    runs-on: ubuntu-latest
    if: needs.check_version.outputs.release_created == 'true'
    steps:
      - name: Trigger Homebrew tap update
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          echo "Triggering repository dispatch for version: ${{ needs.check_version.outputs.version }}"
          echo "SHA256 values (calculated from built files):"
          echo "  aarch64-apple-darwin: ${{ needs.upload_artifacts.outputs.sha256_aarch64_apple_darwin }}"
          echo "  x86_64-apple-darwin: ${{ needs.upload_artifacts.outputs.sha256_x86_64_apple_darwin }}"
          echo "  x86_64-unknown-linux-gnu: ${{ needs.upload_artifacts.outputs.sha256_x86_64_unknown_linux_gnu }}"
          
          response=$(curl -w "%{http_code}" -s -o /tmp/dispatch_response.json -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/bixu/homebrew-apiary/dispatches \
            -d "{
              \"event_type\": \"update-formula\",
              \"client_payload\": {
                \"version\": \"${{ needs.check_version.outputs.version }}\",
                \"release_url\": \"https://github.com/${{ github.repository }}/releases/tag/${{ needs.check_version.outputs.version }}\",
                \"sha\": \"${{ github.sha }}\",
                \"sha256_aarch64_apple_darwin\": \"${{ needs.upload_artifacts.outputs.sha256_aarch64_apple_darwin }}\",
                \"sha256_x86_64_apple_darwin\": \"${{ needs.upload_artifacts.outputs.sha256_x86_64_apple_darwin }}\",
                \"sha256_x86_64_unknown_linux_gnu\": \"${{ needs.upload_artifacts.outputs.sha256_x86_64_unknown_linux_gnu }}\"
              }
            }")
          
          echo "HTTP Response Code: $response"
          echo "Response Body:"
          cat /tmp/dispatch_response.json
          
          if [ "$response" -ne 204 ]; then
            echo "❌ Failed to trigger repository dispatch (expected HTTP 204)"
            exit 1
          else
            echo "✅ Successfully triggered repository dispatch"
          fi
