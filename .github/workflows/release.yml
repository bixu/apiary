name: Release

on:
  release:
    types: [published]

jobs:
  apiary:
    name: apiary ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-apple-darwin
            os: macos-13
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: build
        run: |
          export TARGET="${{ matrix.target }}"
          echo "Rust target is $TARGET"
          echo "target=$TARGET" >> $GITHUB_OUTPUT

      - run: rustup toolchain install stable --profile minimal

      - run: rustup target add ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Compile and release
        id: compile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUSTTARGET: ${{ matrix.target }}
        run: |
          cargo build --release --target "${RUSTTARGET}"
          
          # Create directory for packaging
          mkdir -p dist
          
          # Copy binary and create tar.gz archive
          cp target/${RUSTTARGET}/release/apiary dist/
          tar -czf apiary-${RUSTTARGET}.tar.gz -C dist apiary
          
          # Calculate SHA256 for Homebrew formula (cross-platform)
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum apiary-${RUSTTARGET}.tar.gz > apiary-${RUSTTARGET}.tar.gz.sha256
          else
            shasum -a 256 apiary-${RUSTTARGET}.tar.gz > apiary-${RUSTTARGET}.tar.gz.sha256
          fi
          
          echo "archive=apiary-${RUSTTARGET}.tar.gz" >> $GITHUB_OUTPUT
          echo "sha256_file=apiary-${RUSTTARGET}.tar.gz.sha256" >> $GITHUB_OUTPUT

      - name: Upload SHA256 as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sha256-${{ matrix.target }}
          path: apiary-${{ matrix.target }}.tar.gz.sha256

      - name: Upload release archive
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./apiary-${{ matrix.target }}.tar.gz
          asset_name: apiary-${{ matrix.target }}.tar.gz
          asset_content_type: application/gzip

  collect-artifacts:
    needs: apiary
    runs-on: ubuntu-latest
    if: github.event.action == 'published'
    outputs:
      sha256_aarch64_apple_darwin: ${{ steps.collect.outputs.sha256_aarch64_apple_darwin }}
      sha256_x86_64_apple_darwin: ${{ steps.collect.outputs.sha256_x86_64_apple_darwin }}
      sha256_x86_64_unknown_linux_gnu: ${{ steps.collect.outputs.sha256_x86_64_unknown_linux_gnu }}
    steps:
      - name: Download SHA256 artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: sha256-*
          merge-multiple: true

      - name: Collect SHA256 hashes
        id: collect
        run: |
          if [ -f "apiary-aarch64-apple-darwin.tar.gz.sha256" ]; then
            sha256_aarch64=$(cat apiary-aarch64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
            echo "sha256_aarch64_apple_darwin=$sha256_aarch64" >> $GITHUB_OUTPUT
          fi

          if [ -f "apiary-x86_64-apple-darwin.tar.gz.sha256" ]; then
            sha256_x86_64_darwin=$(cat apiary-x86_64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
            echo "sha256_x86_64_apple_darwin=$sha256_x86_64_darwin" >> $GITHUB_OUTPUT
          fi

          if [ -f "apiary-x86_64-unknown-linux-gnu.tar.gz.sha256" ]; then
            sha256_x86_64_linux=$(cat apiary-x86_64-unknown-linux-gnu.tar.gz.sha256 | awk '{print $1}')
            echo "sha256_x86_64_unknown_linux_gnu=$sha256_x86_64_linux" >> $GITHUB_OUTPUT
          fi

  trigger-homebrew-update:
    needs: [apiary, collect-artifacts]
    runs-on: ubuntu-latest
    if: github.event.action == 'published'
    steps:
      - name: Trigger Homebrew tap update
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          echo "Triggering repository dispatch for version: ${{ github.event.release.tag_name }}"
          
          response=$(curl -w "%{http_code}" -s -o /tmp/dispatch_response.json -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/bixu/homebrew-apiary/dispatches \
            -d "{
              \"event_type\": \"update-formula\",
              \"client_payload\": {
                \"version\": \"${{ github.event.release.tag_name }}\",
                \"release_url\": \"${{ github.event.release.html_url }}\",
                \"sha\": \"${{ github.sha }}\",
                \"sha256_aarch64_apple_darwin\": \"${{ needs.collect-artifacts.outputs.sha256_aarch64_apple_darwin }}\",
                \"sha256_x86_64_apple_darwin\": \"${{ needs.collect-artifacts.outputs.sha256_x86_64_apple_darwin }}\",
                \"sha256_x86_64_unknown_linux_gnu\": \"${{ needs.collect-artifacts.outputs.sha256_x86_64_unknown_linux_gnu }}\"
              }
            }")
          
          echo "HTTP Response Code: $response"
          echo "Response Body:"
          cat /tmp/dispatch_response.json
          
          if [ "$response" -ne 204 ]; then
            echo "❌ Failed to trigger repository dispatch (expected HTTP 204)"
            exit 1
          else
            echo "✅ Successfully triggered repository dispatch"
          fi
