name: Release

on:
  push:
    branches:
      - main
    paths:
      - '**/*.rs'
      - 'Cargo.toml'

jobs:
  check_version:
    name: Check Version and Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_created: ${{ steps.release.outputs.release_created }}
      upload_url: ${{ steps.release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"

      - name: Check if tag exists
        id: tag_check
        run: |
          if git tag --list | grep -q "^${{ steps.version.outputs.version }}$"; then
            echo "Tag ${{ steps.version.outputs.version }} already exists"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Tag ${{ steps.version.outputs.version }} does not exist"
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create tag and release
        id: release
        if: steps.tag_check.outputs.tag_exists == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="$VERSION"
          
          # Create and push tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release version $VERSION"
          git push origin "$TAG_NAME"
          
          # Create GitHub release
          response=$(curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            -d "{
              \"tag_name\": \"$TAG_NAME\",
              \"target_commitish\": \"${{ github.sha }}\",
              \"name\": \"Release $VERSION\",
              \"body\": \"Release version $VERSION\",
              \"draft\": false,
              \"prerelease\": false
            }")
          
          upload_url=$(echo "$response" | jq -r '.upload_url')
          release_id=$(echo "$response" | jq -r '.id')
          
          echo "release_created=true" >> $GITHUB_OUTPUT
          echo "upload_url=$upload_url" >> $GITHUB_OUTPUT
          echo "release_id=$release_id" >> $GITHUB_OUTPUT
          echo "Created release with upload URL: $upload_url"

  apiary:
    name: apiary ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: check_version
    if: needs.check_version.outputs.release_created == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-apple-darwin
            os: macos-13
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: build
        run: |
          export TARGET="${{ matrix.target }}"
          echo "Rust target is $TARGET"
          echo "target=$TARGET" >> $GITHUB_OUTPUT

      - run: rustup toolchain install stable --profile minimal

      - run: rustup target add ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Compile and release
        id: compile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUSTTARGET: ${{ matrix.target }}
        run: |
          cargo build --release --target "${RUSTTARGET}"
          
          # Create directory for packaging
          mkdir -p dist
          
          # Copy binary and create tar.gz archive
          cp target/${RUSTTARGET}/release/apiary dist/
          tar -czf apiary-${RUSTTARGET}.tar.gz -C dist apiary
          
          # Calculate SHA256 for Homebrew formula (cross-platform)
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum apiary-${RUSTTARGET}.tar.gz > apiary-${RUSTTARGET}.tar.gz.sha256
          else
            shasum -a 256 apiary-${RUSTTARGET}.tar.gz > apiary-${RUSTTARGET}.tar.gz.sha256
          fi
          
          echo "archive=apiary-${RUSTTARGET}.tar.gz" >> $GITHUB_OUTPUT
          echo "sha256_file=apiary-${RUSTTARGET}.tar.gz.sha256" >> $GITHUB_OUTPUT

      - name: Upload SHA256 as artifact
        uses: actions/upload-artifact@v5
        with:
          name: sha256-${{ matrix.target }}
          path: apiary-${{ matrix.target }}.tar.gz.sha256

      - name: Upload release archive
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.check_version.outputs.upload_url }}
          asset_path: ./apiary-${{ matrix.target }}.tar.gz
          asset_name: apiary-${{ matrix.target }}.tar.gz
          asset_content_type: application/gzip

  collect_artifacts:
    needs: [check_version, apiary]
    runs-on: ubuntu-latest
    if: needs.check_version.outputs.release_created == 'true'
    outputs:
      sha256_aarch64_apple_darwin: ${{ steps.collect.outputs.sha256_aarch64_apple_darwin }}
      sha256_x86_64_apple_darwin: ${{ steps.collect.outputs.sha256_x86_64_apple_darwin }}
      sha256_x86_64_unknown_linux_gnu: ${{ steps.collect.outputs.sha256_x86_64_unknown_linux_gnu }}
    steps:
      - name: Download SHA256 artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: sha256-*
          merge-multiple: true

      - name: Collect SHA256 hashes
        id: collect
        run: |
          if [ -f "apiary-aarch64-apple-darwin.tar.gz.sha256" ]; then
            sha256_aarch64=$(cat apiary-aarch64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
            echo "sha256_aarch64_apple_darwin=$sha256_aarch64" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "apiary-x86_64-apple-darwin.tar.gz.sha256" ]; then
            sha256_x86_64_darwin=$(cat apiary-x86_64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
            echo "sha256_x86_64_apple_darwin=$sha256_x86_64_darwin" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "apiary-x86_64-unknown-linux-gnu.tar.gz.sha256" ]; then
            sha256_x86_64_linux=$(cat apiary-x86_64-unknown-linux-gnu.tar.gz.sha256 | awk '{print $1}')
            echo "sha256_x86_64_unknown_linux_gnu=$sha256_x86_64_linux" >> $GITHUB_OUTPUT
          fi

  trigger-homebrew-update:
    needs: [check_version, collect_artifacts]
    runs-on: ubuntu-latest
    if: needs.check_version.outputs.release_created == 'true'
    steps:
      - name: Trigger Homebrew tap update
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          echo "Triggering repository dispatch for version: ${{ needs.check_version.outputs.version }}"
          
          response=$(curl -w "%{http_code}" -s -o /tmp/dispatch_response.json -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/bixu/homebrew-apiary/dispatches \
            -d "{
              \"event_type\": \"update-formula\",
              \"client_payload\": {
                \"version\": \"${{ needs.check_version.outputs.version }}\",
                \"release_url\": \"https://github.com/${{ github.repository }}/releases/tag/${{ needs.check_version.outputs.version }}\",
                \"sha\": \"${{ github.sha }}\",
                \"sha256_aarch64_apple_darwin\": \"${{ needs.collect_artifacts.outputs.sha256_aarch64_apple_darwin }}\",
                \"sha256_x86_64_apple_darwin\": \"${{ needs.collect_artifacts.outputs.sha256_x86_64_apple_darwin }}\",
                \"sha256_x86_64_unknown_linux_gnu\": \"${{ needs.collect_artifacts.outputs.sha256_x86_64_unknown_linux_gnu }}\"
              }
            }")
          
          echo "HTTP Response Code: $response"
          echo "Response Body:"
          cat /tmp/dispatch_response.json
          
          if [ "$response" -ne 204 ]; then
            echo "❌ Failed to trigger repository dispatch (expected HTTP 204)"
            exit 1
          else
            echo "✅ Successfully triggered repository dispatch"
          fi
