name: Release

on:
  release:
    types: [published]

jobs:
  apiary:
    name: apiary ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-apple-darwin
            os: macos-13
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: build
        run: |
          export TARGET="${{ matrix.target }}"
          echo "Rust target is $TARGET"
          echo "target=$TARGET" >> $GITHUB_OUTPUT

      - run: rustup toolchain install stable --profile minimal

      - run: rustup target add ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Compile and release
        id: compile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUSTTARGET: ${{ matrix.target }}
        run: |
          cargo build --release --target "${RUSTTARGET}"
          
          # Create directory for packaging
          mkdir -p dist
          
          # Copy binary and create tar.gz archive
          cp target/${RUSTTARGET}/release/apiary dist/
          tar -czf apiary-${RUSTTARGET}.tar.gz -C dist apiary
          
          # Calculate SHA256 for Homebrew formula (cross-platform)
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum apiary-${RUSTTARGET}.tar.gz > apiary-${RUSTTARGET}.tar.gz.sha256
          else
            shasum -a 256 apiary-${RUSTTARGET}.tar.gz > apiary-${RUSTTARGET}.tar.gz.sha256
          fi
          
          echo "archive=apiary-${RUSTTARGET}.tar.gz" >> $GITHUB_OUTPUT
          echo "sha256_file=apiary-${RUSTTARGET}.tar.gz.sha256" >> $GITHUB_OUTPUT

      - name: Upload release archive
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./apiary-${{ matrix.target }}.tar.gz
          asset_name: apiary-${{ matrix.target }}.tar.gz
          asset_content_type: application/gzip

  trigger-homebrew-update:
    needs: apiary
    runs-on: ubuntu-latest
    if: github.event.action == 'published'
    steps:
      - name: Trigger Homebrew tap update
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/bixu/homebrew-apiary/dispatches \
            -d "{
              \"event_type\": \"update-formula\",
              \"client_payload\": {
                \"version\": \"${{ github.event.release.tag_name }}\",
                \"release_url\": \"${{ github.event.release.html_url }}\"
              }
            }"
